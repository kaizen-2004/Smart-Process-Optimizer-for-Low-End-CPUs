#include <Wire.h>

// Include Adafruit Graphics & OLED libraries
#include <Adafruit_GFX.h>
#include <Adafruit_SH110X.h>

#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_RESET -1

// Create SH1106 display object (128x64)
Adafruit_SH1106G display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, OLED_RESET);

// Buzzer pin
const int buzzerPin = 9;

// Threshold values
const int CPU_ALERT_THRESHOLD = 80;    // 80% CPU usage
const int RAM_ALERT_THRESHOLD = 85;    // 85% RAM usage

// Variables to store system stats
float cpuUsage = 0;
float ramUsage = 0;

// Buzzer variables
bool alertActive = false;
unsigned long lastAlertTime = 0;
const unsigned long alertInterval = 1000; // 1 second between beeps


 const byte PROGMEM loading[][288] = {
  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,12,0,0,48,0,0,14,0,0,112,0,0,7,128,1,224,0,0,1,192,3,128,0,0,0,240,15,0,0,0,0,56,28,0,0,0,0,56,28,0,0,0,0,240,15,0,0,0,1,192,3,128,0,0,3,128,1,192,0,0,6,0,0,96,0,0,12,0,0,48,0,0,24,1,128,24,0,0,24,7,224,24,0,0,24,15,240,24,0,0,24,63,252,24,0,0,16,127,254,8,0,0,16,127,254,8,0,0,16,255,255,8,0,0,16,255,255,8,0,0,17,255,255,136,0,0,17,255,255,136,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0},
  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,12,0,0,48,0,0,14,0,0,112,0,0,7,128,1,224,0,0,1,192,3,128,0,0,0,240,15,0,0,0,0,56,28,0,0,0,0,56,28,0,0,0,0,240,15,0,0,0,1,192,3,128,0,0,3,128,1,192,0,0,6,0,0,96,0,0,12,0,0,48,0,0,24,1,128,24,0,0,24,7,224,24,0,0,24,15,240,24,0,0,24,63,252,24,0,0,16,127,254,8,0,0,16,127,254,8,0,0,16,255,255,8,0,0,16,255,255,8,0,0,17,255,255,136,0,0,17,255,255,136,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0},
//  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,12,0,0,48,0,0,14,0,0,112,0,0,7,128,1,224,0,0,1,192,3,128,0,0,0,240,15,0,0,0,0,56,28,0,0,0,0,56,28,0,0,0,0,240,15,0,0,0,1,192,3,128,0,0,3,128,1,192,0,0,6,0,0,96,0,0,12,0,0,48,0,0,24,1,128,24,0,0,24,7,224,24,0,0,24,15,240,24,0,0,24,63,252,24,0,0,16,127,254,8,0,0,16,127,254,8,0,0,16,255,255,8,0,0,16,255,255,8,0,0,17,255,255,136,0,0,17,255,255,136,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0},
  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,12,0,0,48,0,0,14,0,0,112,0,0,7,128,1,224,0,0,1,192,3,128,0,0,0,240,15,0,0,0,0,56,28,0,0,0,0,56,28,0,0,0,0,240,15,0,0,0,1,192,3,128,0,0,3,128,1,192,0,0,6,0,0,96,0,0,12,0,0,48,0,0,24,1,128,24,0,0,24,7,224,24,0,0,24,15,240,24,0,0,24,63,252,24,0,0,16,127,254,8,0,0,16,127,254,8,0,0,16,255,255,8,0,0,16,255,255,8,0,0,17,255,255,136,0,0,17,255,255,136,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,31,0,0,0,0,0,31,254,0,0,0,0,16,63,252,0,0,0,16,0,127,248,0,0,30,0,0,255,224,0,15,248,0,3,224,0,3,255,240,0,64,0,3,1,255,224,192,0,3,0,3,255,192,0,3,0,0,15,128,0,2,0,0,12,0,0,2,0,0,8,0,0,2,0,0,8,0,0,2,0,0,24,0,0,2,0,0,24,0,0,3,0,0,24,0,0,3,128,0,24,0,0,1,128,0,48,0,0,0,224,0,112,0,0,0,112,1,224,0,0,0,56,7,128,0,0,0,28,31,0,0,0,0,248,56,0,0,0,1,224,28,0,0,0,7,128,14,0,0,0,14,0,7,0,0,0,12,0,1,128,0,0,24,0,1,192,0,0,24,3,224,192,0,0,24,31,240,192,0,0,24,127,248,64,0,0,16,255,248,64,0,0,17,255,248,64,0,0,49,255,252,64,0,1,243,255,252,192,0,3,255,255,252,192,0,2,7,255,252,192,0,2,0,15,255,192,0,7,192,0,31,248,0,7,255,0,0,120,0,0,63,254,0,8,0,0,0,127,252,8,0,0,0,0,255,248,0,0,0,0,1,248,0,0,0,0,0,0,0,0,0,0,0,0,0},
//  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,7,128,0,0,0,0,6,192,0,0,0,0,4,112,0,0,0,0,6,24,0,0,0,0,7,12,0,0,0,0,3,135,0,0,0,0,3,225,128,0,0,0,6,48,224,0,0,0,12,28,48,0,0,0,8,6,28,0,0,0,24,3,134,0,0,0,16,0,195,128,0,0,16,0,112,192,0,0,16,0,24,112,0,0,24,0,14,24,0,0,24,0,7,16,0,0,8,0,3,240,0,0,12,0,6,224,0,0,12,0,12,0,0,3,252,0,24,0,0,6,0,0,16,0,0,8,0,0,96,0,0,24,0,63,192,0,0,48,0,62,0,0,7,96,0,48,0,0,15,195,248,16,0,0,8,239,255,24,0,0,24,127,255,136,0,0,14,31,255,136,0,0,3,14,255,136,0,0,1,195,255,136,0,0,0,97,255,24,0,0,0,56,111,16,0,0,0,12,62,48,0,0,0,7,14,96,0,0,0,1,135,192,0,0,0,0,227,192,0,0,0,0,48,224,0,0,0,0,24,96,0,0,0,0,6,32,0,0,0,0,3,96,0,0,0,0,1,224,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,0,0,0,30,0,0,0,0,0,54,0,0,0,0,0,34,0,0,0,0,0,50,0,0,0,0,1,243,0,0,0,0,15,243,0,3,0,0,60,17,0,15,128,0,32,17,0,8,131,128,96,25,0,8,255,224,192,25,128,12,240,56,192,9,128,12,192,12,128,8,128,4,192,7,128,12,128,4,94,3,0,12,192,6,79,1,0,12,192,6,111,128,0,4,64,2,111,192,0,4,64,2,47,224,0,6,64,2,39,240,0,6,96,3,55,240,128,2,96,3,55,248,192,2,32,1,55,249,224,3,32,1,19,241,48,3,48,1,147,243,28,15,48,1,155,227,7,255,16,0,155,134,1,193,16,0,136,12,0,1,240,0,136,56,0,0,192,0,207,240,0,0,0,0,207,128,0,0,0,0,76,0,0,0,0,0,68,0,0,0,0,0,108,0,0,0,0,0,124,0,0,0,0,0,32,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0},
  {0,0,32,0,0,0,0,0,112,0,0,0,0,0,252,0,0,0,0,0,204,0,0,0,0,1,140,0,0,0,0,3,24,0,0,0,0,6,56,0,0,0,0,12,60,0,0,0,0,12,110,0,0,0,0,24,199,0,0,0,0,49,129,128,0,0,0,99,16,192,0,0,0,195,56,96,0,0,0,198,56,96,0,0,1,140,124,96,0,0,3,24,252,32,0,0,6,48,252,32,0,0,12,49,252,32,0,0,12,99,252,96,0,0,24,199,248,99,240,0,49,135,248,127,248,0,99,15,248,120,14,0,195,31,248,0,7,28,199,15,240,0,1,183,237,131,192,0,0,227,56,192,0,0,0,195,0,112,30,0,0,198,0,63,254,0,1,140,0,15,198,0,3,24,0,0,6,0,6,48,0,0,4,0,12,48,0,0,4,0,12,96,0,0,4,0,24,192,0,0,6,0,49,128,0,0,6,0,99,0,0,0,7,0,195,0,0,0,3,0,198,0,0,0,1,129,140,0,0,0,0,195,24,0,0,0,0,118,48,0,0,0,0,60,112,0,0,0,0,28,96,0,0,0,0,24,192,0,0,0,0,49,128,0,0,0,0,51,0,0,0,0,0,63,0,0,0,0,0,14,0,0,0,0,0,4,0,0},
//  {0,0,0,0,0,0,0,0,0,0,248,0,0,0,0,63,248,0,0,0,15,255,24,0,0,3,255,128,8,0,0,255,224,0,24,0,7,248,0,7,248,0,6,0,1,255,192,0,6,0,127,240,192,0,6,31,252,0,192,0,7,255,0,0,192,0,3,224,0,12,192,0,0,48,0,124,64,0,0,48,7,252,64,0,0,48,127,252,96,0,0,49,255,248,96,0,0,49,255,248,192,0,0,17,255,240,192,0,0,24,255,225,192,0,0,24,127,195,128,0,0,12,31,135,0,0,0,7,0,14,0,0,0,3,192,28,0,0,0,0,240,56,0,0,0,0,28,15,0,0,0,0,56,3,192,0,0,0,112,0,224,0,0,0,224,0,48,0,0,1,192,0,24,0,0,3,128,0,24,0,0,3,0,0,8,0,0,3,0,0,12,0,0,6,0,0,12,0,0,6,0,0,12,0,0,6,0,0,12,0,0,2,0,0,12,0,0,3,0,0,7,192,0,3,0,0,255,224,0,3,0,63,248,96,0,3,15,254,0,96,0,3,255,128,0,96,0,31,224,0,31,224,0,24,0,7,254,0,0,16,1,255,128,0,0,16,255,224,0,0,0,31,252,0,0,0,0,31,0,0,0,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,126,0,0,0,0,0,127,255,0,0,0,0,96,127,255,192,0,0,96,0,63,255,224,0,96,0,0,31,224,0,63,224,0,0,96,0,31,255,252,0,96,0,6,7,255,255,224,0,6,0,3,255,192,0,6,0,0,12,0,0,6,0,0,12,0,0,4,0,0,12,0,0,4,0,0,12,0,0,4,127,255,140,0,0,6,127,255,136,0,0,6,127,255,24,0,0,6,63,255,24,0,0,3,63,254,24,0,0,3,143,252,48,0,0,1,199,248,112,0,0,0,97,225,224,0,0,0,56,7,128,0,0,0,60,30,0,0,0,0,120,60,0,0,0,1,224,28,0,0,0,3,128,6,0,0,0,14,0,3,128,0,0,12,0,1,192,0,0,24,0,0,192,0,0,24,0,0,96,0,0,24,0,0,96,0,0,16,0,0,96,0,0,48,0,0,32,0,0,48,0,0,32,0,0,48,0,0,32,0,0,48,0,0,96,0,0,48,0,0,96,0,3,255,192,0,96,0,7,255,255,224,96,0,6,0,63,255,248,0,6,0,0,7,252,0,7,248,0,0,6,0,7,255,252,0,6,0,0,1,255,254,6,0,0,0,0,255,254,0,0,0,0,0,62,0,0,0,0,0,0,0},
  {0,0,0,0,0,0,0,255,192,0,0,0,0,255,255,255,252,0,1,128,1,255,255,224,1,128,0,0,0,224,1,192,0,0,0,96,0,255,255,128,0,96,0,63,255,255,255,192,0,12,0,3,255,192,0,12,0,0,12,0,0,12,0,0,12,0,0,12,0,0,12,0,0,8,0,0,12,0,0,8,127,255,140,0,0,8,127,255,136,0,0,12,127,255,24,0,0,12,127,255,24,0,0,12,63,254,24,0,0,6,63,252,56,0,0,7,15,248,112,0,0,3,135,240,224,0,0,0,224,131,192,0,0,0,112,7,128,0,0,0,56,30,0,0,0,0,120,28,0,0,0,1,224,14,0,0,0,3,192,7,0,0,0,7,0,1,192,0,0,14,0,0,224,0,0,28,0,0,96,0,0,24,0,0,48,0,0,24,0,0,48,0,0,24,0,0,48,0,0,16,0,0,16,0,0,48,0,0,16,0,0,48,0,0,16,0,0,48,0,0,48,0,0,48,0,0,48,0,0,48,0,0,48,0,1,255,192,0,48,0,3,255,255,255,252,0,6,0,1,255,255,0,6,0,0,0,3,0,6,0,0,0,1,128,7,255,255,128,1,128,0,63,255,255,255,0,0,0,0,31,255,0,0,0,0,0,0,0},
//  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,255,255,8,0,0,24,255,255,24,0,0,24,255,255,24,0,0,24,127,254,24,0,0,24,63,252,24,0,0,12,63,252,48,0,0,14,31,248,112,0,0,7,135,225,224,0,0,1,192,3,128,0,0,0,240,15,0,0,0,0,56,28,0,0,0,0,56,28,0,0,0,0,240,15,0,0,0,1,192,3,128,0,0,3,128,1,192,0,0,6,0,0,96,0,0,12,0,0,48,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0},
  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,255,255,8,0,0,24,255,255,24,0,0,24,255,255,24,0,0,24,127,254,24,0,0,24,63,252,24,0,0,12,63,252,48,0,0,14,31,248,112,0,0,7,135,225,224,0,0,1,192,3,128,0,0,0,240,15,0,0,0,0,56,28,0,0,0,0,56,28,0,0,0,0,240,15,0,0,0,1,192,3,128,0,0,3,128,1,192,0,0,6,0,0,96,0,0,12,0,0,48,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0},
  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,255,255,8,0,0,24,255,255,24,0,0,24,255,255,24,0,0,24,127,254,24,0,0,24,63,252,24,0,0,12,63,252,48,0,0,14,31,248,112,0,0,7,135,225,224,0,0,1,192,3,128,0,0,0,240,15,0,0,0,0,56,28,0,0,0,0,56,28,0,0,0,0,240,15,0,0,0,1,192,3,128,0,0,3,128,1,192,0,0,6,0,0,96,0,0,12,0,0,48,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0},
//  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,255,255,8,0,0,24,255,255,24,0,0,24,255,255,24,0,0,24,127,254,24,0,0,24,63,252,24,0,0,12,63,252,48,0,0,14,31,248,112,0,0,7,135,225,224,0,0,1,192,3,128,0,0,0,240,15,0,0,0,0,56,28,0,0,0,0,56,28,0,0,0,0,240,15,0,0,0,1,192,3,128,0,0,3,128,1,192,0,0,6,0,0,96,0,0,12,0,0,48,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0},
  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,255,255,8,0,0,24,255,255,24,0,0,24,255,255,24,0,0,24,127,254,24,0,0,24,63,252,24,0,0,12,63,252,48,0,0,14,31,248,112,0,0,7,135,225,224,0,0,1,192,3,128,0,0,0,240,15,0,0,0,0,56,28,0,0,0,0,56,28,0,0,0,0,240,15,0,0,0,1,192,3,128,0,0,3,128,1,192,0,0,6,0,0,96,0,0,12,0,0,48,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0},
  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,255,255,8,0,0,24,255,255,24,0,0,24,255,255,24,0,0,24,127,254,24,0,0,24,63,252,24,0,0,12,63,252,48,0,0,14,31,248,112,0,0,7,135,225,224,0,0,1,192,3,128,0,0,0,240,15,0,0,0,0,56,28,0,0,0,0,56,28,0,0,0,0,240,15,0,0,0,1,192,3,128,0,0,3,128,1,192,0,0,6,0,0,96,0,0,12,0,0,48,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0},
//  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,255,255,8,0,0,24,255,255,24,0,0,24,255,255,24,0,0,24,127,254,24,0,0,24,63,252,24,0,0,12,63,252,48,0,0,14,31,248,112,0,0,7,135,225,224,0,0,1,192,3,128,0,0,0,240,15,0,0,0,0,56,28,0,0,0,0,56,28,0,0,0,0,240,15,0,0,0,1,192,3,128,0,0,3,128,1,192,0,0,6,0,0,96,0,0,12,0,0,48,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0},
  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,255,255,8,0,0,24,255,255,24,0,0,24,255,255,24,0,0,24,127,254,24,0,0,24,63,252,24,0,0,12,63,252,48,0,0,14,31,248,112,0,0,7,135,225,224,0,0,1,193,131,128,0,0,0,241,143,0,0,0,0,57,156,0,0,0,0,56,28,0,0,0,0,240,15,0,0,0,1,192,3,128,0,0,3,128,1,192,0,0,6,0,0,96,0,0,12,0,0,48,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0},
  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,24,255,255,24,0,0,24,255,255,24,0,0,24,127,254,24,0,0,24,63,252,24,0,0,12,63,252,48,0,0,14,31,248,112,0,0,7,135,225,224,0,0,1,193,131,128,0,0,0,241,143,0,0,0,0,57,156,0,0,0,0,57,156,0,0,0,0,241,143,0,0,0,1,193,131,128,0,0,3,129,129,192,0,0,6,1,128,96,0,0,12,1,128,48,0,0,24,1,128,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0},
//  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,127,254,24,0,0,24,63,252,24,0,0,12,63,252,48,0,0,14,31,248,112,0,0,7,135,225,224,0,0,1,193,131,128,0,0,0,241,143,0,0,0,0,57,156,0,0,0,0,57,156,0,0,0,0,241,143,0,0,0,1,193,131,128,0,0,3,129,129,192,0,0,6,1,128,96,0,0,12,1,128,48,0,0,24,1,128,24,0,0,24,1,128,24,0,0,24,1,128,24,0,0,24,1,128,24,0,0,16,1,128,8,0,0,16,1,128,8,0,0,16,1,128,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0},
  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,12,31,248,48,0,0,14,31,248,112,0,0,7,135,225,224,0,0,1,193,131,128,0,0,0,241,143,0,0,0,0,57,156,0,0,0,0,57,156,0,0,0,0,241,143,0,0,0,1,193,131,128,0,0,3,129,129,192,0,0,6,1,128,96,0,0,12,1,128,48,0,0,24,1,128,24,0,0,24,1,128,24,0,0,24,1,128,24,0,0,24,1,128,24,0,0,16,1,128,8,0,0,16,1,128,8,0,0,16,1,128,8,0,0,16,1,128,8,0,0,16,3,224,8,0,0,16,15,240,8,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0},
  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,12,0,0,48,0,0,14,0,0,112,0,0,7,129,129,224,0,0,1,193,131,128,0,0,0,241,143,0,0,0,0,57,156,0,0,0,0,57,156,0,0,0,0,241,143,0,0,0,1,193,131,128,0,0,3,129,129,192,0,0,6,1,128,96,0,0,12,1,128,48,0,0,24,1,128,24,0,0,24,1,128,24,0,0,24,1,128,24,0,0,24,1,128,24,0,0,16,1,128,8,0,0,16,3,192,8,0,0,16,15,240,8,0,0,16,31,248,8,0,0,16,63,252,8,0,0,16,127,254,8,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0},
//  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,12,0,0,48,0,0,14,0,0,112,0,0,7,128,1,224,0,0,1,192,3,128,0,0,0,240,15,0,0,0,0,56,28,0,0,0,0,56,28,0,0,0,0,240,15,0,0,0,1,193,131,128,0,0,3,129,129,192,0,0,6,1,128,96,0,0,12,1,128,48,0,0,24,1,128,24,0,0,24,1,128,24,0,0,24,1,128,24,0,0,24,7,224,24,0,0,16,15,240,8,0,0,16,63,252,8,0,0,16,127,254,8,0,0,16,127,254,8,0,0,16,255,255,8,0,0,16,255,255,8,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0},
  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,12,0,0,48,0,0,14,0,0,112,0,0,7,128,1,224,0,0,1,192,3,128,0,0,0,240,15,0,0,0,0,56,28,0,0,0,0,56,28,0,0,0,0,240,15,0,0,0,1,192,3,128,0,0,3,128,1,192,0,0,6,0,0,96,0,0,12,0,0,48,0,0,24,1,128,24,0,0,24,3,192,24,0,0,24,15,240,24,0,0,24,31,248,24,0,0,16,63,252,8,0,0,16,127,254,8,0,0,16,255,255,8,0,0,16,255,255,8,0,0,17,255,255,136,0,0,17,255,255,136,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0},
  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,12,0,0,48,0,0,14,0,0,112,0,0,7,128,1,224,0,0,1,192,3,128,0,0,0,240,15,0,0,0,0,56,28,0,0,0,0,56,28,0,0,0,0,240,15,0,0,0,1,192,3,128,0,0,3,128,1,192,0,0,6,0,0,96,0,0,12,0,0,48,0,0,24,3,192,24,0,0,24,15,240,24,0,0,24,31,248,24,0,0,24,63,252,24,0,0,16,127,254,8,0,0,16,255,255,8,0,0,16,255,255,8,0,0,16,255,255,136,0,0,17,255,255,136,0,0,17,255,255,136,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0},
//  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,12,0,0,48,0,0,14,0,0,112,0,0,7,128,1,224,0,0,1,192,3,128,0,0,0,240,15,0,0,0,0,56,28,0,0,0,0,56,28,0,0,0,0,240,15,0,0,0,1,192,3,128,0,0,3,128,1,192,0,0,6,0,0,96,0,0,12,0,0,48,0,0,24,3,192,24,0,0,24,15,240,24,0,0,24,31,248,24,0,0,24,63,252,24,0,0,16,127,254,8,0,0,16,255,255,8,0,0,16,255,255,8,0,0,16,255,255,136,0,0,17,255,255,136,0,0,17,255,255,136,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0},
  {0,0,0,0,0,0,3,255,255,255,255,192,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,1,255,255,255,255,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,16,0,0,8,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,24,0,0,12,0,0,48,0,0,14,0,0,112,0,0,7,128,1,224,0,0,1,192,3,128,0,0,0,240,15,0,0,0,0,56,28,0,0,0,0,56,28,0,0,0,0,240,15,0,0,0,1,192,3,128,0,0,3,128,1,192,0,0,6,0,0,96,0,0,12,0,0,48,0,0,24,3,192,24,0,0,24,15,240,24,0,0,24,31,248,24,0,0,24,63,252,24,0,0,16,127,254,8,0,0,16,255,255,8,0,0,16,255,255,8,0,0,16,255,255,136,0,0,17,255,255,136,0,0,17,255,255,136,0,1,255,255,255,255,0,3,255,255,255,255,192,3,0,0,0,0,192,3,0,0,0,0,192,3,0,0,0,0,192,3,255,255,255,255,192,3,255,255,255,255,192,0,0,0,0,0,0}
};

#define FRAME_DELAY 42
#define FRAME_WIDTH 48
#define FRAME_HEIGHT 48
const int FRAME_COUNT = sizeof(loading) / sizeof(loading[0]);

void setup() {
  // Start Serial communication
  Serial.begin(9600);
  
  // Start Wire library for I2C
  Wire.begin();
  
  // Initialize buzzer pin
  pinMode(buzzerPin, OUTPUT);
  digitalWrite(buzzerPin, LOW);
  
  // Initialize OLED with I2C addr 0x3C
  if(!display.begin(0x3C, true)) {
    for(;;);
  }
  
  // Clear the display buffer
  display.clearDisplay();
  display.display();
  
  Serial.println("System Monitor with Passive Buzzer Ready");
  delay(100);
}

void playLoadingAnimation(const uint8_t frames[][288], int frameCount, int frameDelay) {
  for (int i = 0; i < frameCount; i++) {
    display.clearDisplay();
    display.drawBitmap(
      (SCREEN_WIDTH - FRAME_WIDTH) / 2,
      (SCREEN_HEIGHT - FRAME_HEIGHT) / 2,
      frames[i],
      FRAME_WIDTH,
      FRAME_HEIGHT,
      SH110X_WHITE
    );
    display.display();
    delay(frameDelay);
  }
}


void readJSONData() {
    // Check if data is available
    if (Serial.available() > 0) {
        String jsonData = Serial.readStringUntil('\n');
        jsonData.trim();

        if (jsonData.length() > 0) {
            // Parse CPU usage
            int cpuIndex = jsonData.indexOf("\"cpu_usage\":");
            if (cpuIndex != -1) {
                int cpuStart = cpuIndex + 12;
                int cpuEnd = jsonData.indexOf(",", cpuStart);
                if (cpuEnd == -1) cpuEnd = jsonData.indexOf("}", cpuStart);

                String cpuStr = jsonData.substring(cpuStart, cpuEnd);
                cpuUsage = cpuStr.toFloat();
            }

            // Parse RAM usage
            int ramIndex = jsonData.indexOf("\"ram_usage\":");
            if (ramIndex != -1) {
                int ramStart = ramIndex + 12;
                int ramEnd = jsonData.indexOf("}", ramStart);

                String ramStr = jsonData.substring(ramStart, ramEnd);
                ramUsage = ramStr.toFloat();
            }

            Serial.print("Received - CPU: ");
            Serial.print(cpuUsage);
            Serial.print("%, RAM: ");
            Serial.print(ramUsage);
            Serial.println("%");
        }
    } else {
        display.clearDisplay();
        playLoadingAnimation(loading, FRAME_COUNT, FRAME_DELAY);  // Add parameters
    }
}


void playAlertTone() {
  unsigned long currentTime = millis();
  
  if (currentTime - lastAlertTime >= alertInterval) {
    // Repeat a short, high-pitched beep 3 times quickly
    for (int i = 0; i < 3; i++) {
      tone(buzzerPin, 3000, 150); // 3kHz, 150ms
      delay(200);                 // short pause between beeps
    }
    
    lastAlertTime = currentTime;
  }
}


void stopAlertTone() {
  noTone(buzzerPin); // Stop any playing tone
}

void checkThresholds() {
  bool cpuAlert = (cpuUsage >= CPU_ALERT_THRESHOLD);
  bool ramAlert = (ramUsage >= RAM_ALERT_THRESHOLD);
  
  if (cpuAlert || ramAlert) {
    alertActive = true;
    
    if (cpuAlert && ramAlert) {
      Serial.println("ðŸš¨ CRITICAL: High CPU AND RAM usage!");
      playAlertTone(); // More frequent alerts for critical state
    } 
    else if (cpuAlert) {
      Serial.println("ALERT: High CPU usage!");
      playAlertTone();
    }
    else if (ramAlert) {
      Serial.println("ALERT: High RAM usage!");
      playAlertTone();
    }
  } else {
    if (alertActive) {
      Serial.println("âœ… System normal - alerts cleared");
      alertActive = false;
    }
    stopAlertTone();
  }
}

void displaySystemStats() {
  // Clear the display
  display.clearDisplay();
  
  // Set the color
  display.setTextColor(SH110X_WHITE);
  
  // Display header with alert indicator
  display.setTextSize(1);
  display.setCursor(2, 1);
  if (alertActive) {
    display.print("CPU Process Optimizer");
  } else {
    display.print("CPU Process Optimizer");
  }
  
  // Add a separator line below header
  display.drawLine(0, 10, 127, 10, SH110X_WHITE);
  
  // Display CPU section (left side)
  display.setTextSize(2);
  display.setCursor(5, 20);
  display.print("CPU");
  
  display.setTextSize(2);
  display.setCursor(5, 40);
  if (cpuUsage >= CPU_ALERT_THRESHOLD) {
    // Highlight in alert state
    display.print(">");
    display.print(CPU_ALERT_THRESHOLD);
    display.print("%");
  } else {
    display.print(cpuUsage, 0);
    display.print("%");
  }
  
  // Display vertical separator line
  display.drawLine(64, 15, 64, 55, SH110X_WHITE);
  
  // Display RAM section (right side)
  display.setTextSize(2);
  display.setCursor(75, 20);
  display.print("RAM");
  
  display.setTextSize(2);
  display.setCursor(70, 40);
  if (ramUsage >= RAM_ALERT_THRESHOLD) {
    // Highlight in alert state
    display.print(">");
    display.print(RAM_ALERT_THRESHOLD);
    display.print("%");
  } else {
    display.print(ramUsage, 0);
    display.print("%");
  }
  
  // Display alert status at bottom
  display.setTextSize(1);
  display.setCursor(2, 57);
  if (alertActive) {
    display.print("ALERT ACTIVE!");
  }
}

enum DisplayState { SHOW_STATS, SHOW_LOADING };
DisplayState currentState = SHOW_LOADING;
unsigned long lastDataTime = 0;
const unsigned long DATA_TIMEOUT = 5000; // 5 seconds without data = show loading

void loop() {
    // Check for new data
    if (Serial.available() > 0) {
        readJSONData();
        checkThresholds();
        lastDataTime = millis();
        currentState = SHOW_STATS;
    }
    
    // If no data for 3 seconds, switch to loading
    if (currentState == SHOW_STATS && millis() - lastDataTime > DATA_TIMEOUT) {
        currentState = SHOW_LOADING;
    }
    
    // Update display based on current state
    if (currentState == SHOW_STATS) {
        displaySystemStats();
        display.display();
    } else {
        playLoadingAnimation(loading, FRAME_COUNT, FRAME_DELAY);
    }
    
    delay(100);
}

